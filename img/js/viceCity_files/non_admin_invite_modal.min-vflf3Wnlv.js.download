define(["require","exports","tslib","react","modules/clean/deprecated_ajax/ajax_jquery","classnames","modules/clean/analytics","modules/core/notify","modules/core/i18n","dig-components/modal","dig-components/buttons","dig-components/typography","dig-components/icons","dig-components/icons/src","modules/core/html","modules/clean/contacts/contact","modules/clean/viewer","modules/clean/contacts/tokenizer","modules/clean/contacts/contact_token_state","modules/clean/contacts/types","modules/clean/loggers/join_flow_logger","dig-components/progress_indicators","modules/clean/teams/email_checker_store","modules/core/browser","modules/clean/react/css"],(function(e,t,a,n,i,s,l,o,r,u,m,d,c,f,g,v,_,p,M,h,b,S,k,y,C){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MemberInviteModalWithCSS=t.MemberInviteModal=void 0,n=a.__importDefault(n),i=a.__importStar(i),s=a.__importDefault(s),h=a.__importDefault(h),y=a.__importStar(y);var E=_.Viewer.get_viewer();function w(e){var t=e.open,a=e.onClose,_=e.user,C=e.numAvailableLicenses,w=e.source,I=e.membersSendInviteDomainRestrictionEnabled,D=void 0!==I&&I,A=e.teamBusinessDomains,L=void 0===A?[]:A,N=e.isSuggestionMode,R=e.prepopulatedEmails,q=void 0===R?[]:R,x=n.default.useRef(null),B=n.default.useState(!1),F=B[0],j=B[1],W=n.default.useState(null),z=W[0],O=W[1],U=n.default.useState([]),V=U[0],G=U[1],H=n.default.useState(!1),J=H[0],P=H[1],Q=n.default.useState(new k.EmailCheckerStore("/team/manage/check_can_invite",!1))[0],Y=n.default.useState(null),X=Y[0],Z=Y[1],$=n.default.useState(null),K=$[0],ee=$[1],te=n.default.useState(q?q.map((function(e){return v.Contact.buildFromRawEmail(e)})):[]),ae=te[0],ne=te[1],ie=D&&L.length>0,se=ie?L:null;if(!N&&void 0===C)throw"numAvailableLicenses is required in invite mode";function le(){return(null!=x?(function(){if(null==x.current)return!1;var e=x.current.serializeInputData(x.current).tokens,t=[M.ContactTokenState.ok,M.ContactTokenState.warn];if(0===e.length)return!0;return e.every((function(e){return t.includes(T(e,Q,se).state)}))})():void 0)&&!(null!=x?(function(){if(null==x.current)return!0;var e=x.current.serializeInputData(x.current),t=e.tokens,a=e.value;return 0===t.length&&0===a.length})():void 0)}function oe(e,t){var a=(e=e.filter((function(e){return e.type===h.default.EMAIL&&!e.invalid&&!e.on_team}))).map((function(e){return e.email}));Q.checkEmails(a,(function(){t()}))}if(z){var re=function(){ne([]),O(null),G([]),Z(null),ee(null),a(z)};return n.default.createElement(u.Modal,{open:t,withCloseButton:r.intl.formatMessage({id:"a2rDhR",defaultMessage:"Close"}),onRequestClose:re,className:"suggestion-fallback-modal"},n.default.createElement(u.Modal.Header,{hasBottomSpacing:"title-standard"},n.default.createElement(d.Title,null,r.intl.formatMessage({id:"qn5twm",defaultMessage:"Member requests were sent to the admin"}))),n.default.createElement(u.Modal.Body,{hasVerticalSpacing:!1},n.default.createElement("ul",null,V.map((function(e){return n.default.createElement("li",{key:e},e)})))),n.default.createElement(u.Modal.Footer,null,n.default.createElement(m.Button,{variant:"primary",onClick:re},r.intl.formatMessage({id:"MNcs5F",defaultMessage:"Got it"}))))}var ue=function(){F||(Z(null),ee(null),ne([]),a())},me=L.map((function(e){return"@"+e})),de=r.intl.formatMessage({id:"GoJlu1",defaultMessage:"name"}),ce="";if(ie)switch(me.length){case 1:ce=r.intl.formatMessage({id:"m6/l0s",defaultMessage:"Add any email that ends in {oneDomain}"},{oneDomain:me[0]});break;case 2:ce=r.intl.formatMessage({id:"xw8mQ6",defaultMessage:"Add any email that ends in {firstDomain} or {secondDomain}"},{firstDomain:me[0],secondDomain:me[1]});break;default:ce=r.intl.formatMessage({id:"7aBsbD",defaultMessage:"Add any email that ends in {headDomains} or {lastDomain}"},{headDomains:me.slice(0,me.length-1).join(", ")+",",lastDomain:me[me.length-1]})}function fe(e,t){var a="invite-validation-message",i=a,l=f.FailLine;switch(e){case"warn":l=f.WarningLine,i=s.default(i,a+"__non-admin-invite-modal-warn-extensions");break;case"error":i=s.default(i,a+"__non-admin-invite-modal-error-extensions")}return n.default.createElement("div",{className:i},n.default.createElement(c.UIIcon,{size:"small",src:l,className:a+"__icon"}),n.default.createElement(d.Text,{size:"small",color:"inherit"},t))}return n.default.createElement(u.Modal,{open:t,withCloseButton:r.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"}),onRequestClose:ue,className:"non-admin-invite-modal"},n.default.createElement(u.Modal.Header,{hasBottomSpacing:"title-standard"},n.default.createElement(d.Title,null,N?r.intl.formatMessage({id:"YF+G2c",defaultMessage:"Request Invite"}):r.intl.formatMessage({id:"veD/Im",defaultMessage:"Invite people to {team_name}"},{team_name:E.team_name}))),n.default.createElement(u.Modal.Body,{hasVerticalSpacing:!1},ie&&n.default.createElement("div",{className:"non-admin-invite-modal-team-business-domains"},ce),n.default.createElement(p.ContactsTokenizer,{ref:x,user:_,placeholder:me.length>0?me.map((function(e){return""+de+e})).join(", "):r.intl.formatMessage({id:"w5JCcS",defaultMessage:"Add an email"}),onContentsChange:function(e){oe(e,(function(){(function(e){for(var t=null,a=!0,n=null,i=0,s=e;i<s.length;i++){var l=T(s[i],Q,se),o=l.state,r=l.msg;o!==M.ContactTokenState.ok&&(o===M.ContactTokenState.warn?n=null!=n?n:r:(t=null!=t?t:r,a=!1))}ee(n),Z(t),P(a)})(e)}))},focusOnMount:!0,populatedInputData:{tokens:ae,value:""},customContactValidator:function(e){return T(e,Q,se)},customContactFilter:function(e){return!(e.type!==h.default.EMAIL||e.team||!e.name||e.email===_.email)},disabled:F}),X&&fe("error",X),K&&fe("warn",K)),n.default.createElement(u.Modal.Footer,null,n.default.createElement(m.Button,{disabled:F,variant:"opacity",onClick:ue,"data-testid":"cancel-button"},r.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"})),n.default.createElement(m.Button,{variant:"primary",disabled:!J,onClick:function(){F||(function(e){if(null!=x.current){x.current.tokenizeAll();var t=x.current.getContacts();oe(t,(function(){var a=t.filter((function(e){return e.type===h.default.EMAIL})).map((function(e){return e.email}));e({emails:a})}))}})((function(e){var t=e.emails;if(le()){var n=function(e){ne([]),a(e)};j(!0),N?(function(e,t,a,n){i.WebRequest({url:"/team/manage/suggest-members",data:{emails:e,url:y.get_href(),source:a},complete:function(){return n(!1)},success:function(){return o.Notify.success(r.intl.formatMessage({id:"lMqVLz",defaultMessage:"{num_suggested, plural, one {Thanks for your suggestion! We’ve sent it to the team admin.} other {Thanks for your suggestions! We’ve sent them to the team admin.}}"},{num_suggested:e.length})),t()}})})(t,n,w,j):(function(e,t,a,n,s,u,m){l.TeamsWebActionsLogger.log("invite_member_open_invite_click",{source:n,member_invite_on:!0,invite_count:e.length});var d={emails:e,team_id:E.team_id,invite_source:b.InviteSource.MEMBER_INVITE,poll_events_on_commit:!1,extra:JSON.stringify({member_send_invite_experiment_enabled:!0,origin:n})},c=Array.isArray(e);t<(c?e.length:1)&&(d.charge_for_new_licenses=!0);i.WebRequest({url:"/account/team/add_users",subject_user:E.work_user,data:d,complete:function(){return s(!1)},success:function(t){t=JSON.parse(t);var n=Object.values(t.users),i=t.num_suggested||0;if(n.length>0||i>0){if(0!==i)return i>0&&n.length>0?(o.Notify.success(r.intl.formatMessage({id:"SX0gpY",defaultMessage:"{num_invites, plural, one {Invited # person} other {Invited # people}}."},{num_invites:n.length})+" "+r.intl.formatMessage({id:"lbndFp",defaultMessage:"{num_suggested, plural, one {# invite sent to admin} other {# invites sent to admin}}."},{num_suggested:i})),m(e.filter((function(e){return!n.map((function(e){return e.email})).includes(e)}))),u({num_invited:n.length,invitedUsers:n})):(m(e),u({num_invited:0}));o.Notify.success(r.intl.formatMessage({id:"axSi6e",defaultMessage:"{num_invited, plural, one {Invited.} other {Invited # people.}}"},{num_invited:n.length}))}else o.Notify.error(r.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}));return a({num_invited:n.length,invitedUsers:n})},error:function(e){return"rate-limit"===e.getResponseHeader("x-dropbox-app-error")?o.Notify.error(new g.HTML(r.intl.formatMessage({id:"hQ0rRo",defaultMessage:"{team_name} has reached the maximum number of team members allowed on Dropbox Basic. Please <a>contact sales</a> to add more members to your team."},{team_name:E.team_name,a:function(e){return'<a href="/business/contact">'+e+"</a>"}}))):(l.TeamsWebActionsLogger.log("invite_member_open_invite_error",{source:n,member_invite_on:!0,client:!0}),o.Notify.error(r.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}))),a({num_invited:0})}})})(t,C,n,w,j,O,G)}}))},"data-testid":"submit-button"},F?n.default.createElement(S.Spinner,{inverse:!0,size:"small"}):r.intl.formatMessage({id:"rPSCOl",defaultMessage:"Invite to join"}))))}function T(e,t,a){var n,i,s=e.email;if(e.invalid)i={state:M.ContactTokenState.invalid,msg:r.intl.formatMessage({id:"iWy49e",defaultMessage:"{email} is not a valid email address."},{email:s})};else if(e.on_team)i={state:M.ContactTokenState.invalid,msg:r.intl.formatMessage({id:"w6S6LE",defaultMessage:"User is already a member of this team."})};else{var l=t.getEmailCheckResult(s),o=null;if(l)if(l.inFlight)i={state:M.ContactTokenState.pending,msg:o};else if(l.canInvite){if(i={state:M.ContactTokenState.ok,msg:o},a){var u=null===(n=s.match(/@(.*)$/))||void 0===n?void 0:n[1];u&&!a.includes(u)&&(i={state:M.ContactTokenState.warn,msg:r.intl.formatMessage({id:"LuEFa+",defaultMessage:"Only approved emails are automatically approved"})})}}else"team_member"===l.reason?o=r.intl.formatMessage({id:"/bTRGP",defaultMessage:"This person is already on another team."}):"already_on_this_team"===l.reason?o=r.intl.formatMessage({id:"gUZ177",defaultMessage:"User is already invited to this team."}):"error"===l.reason&&(o=r.intl.formatMessage({id:"I1RVgD",defaultMessage:"User isn’t eligible to join this team."})),i={state:M.ContactTokenState.invalid,msg:o};else i={state:M.ContactTokenState.invalid,msg:o}}return i}t.MemberInviteModal=w,t.MemberInviteModalWithCSS=C.requireCssWithComponent(w,["/static/css/react/contacts_tokenizer-vflPxjRxg.css","/static/css/teams/let_members_invite-vflS05y9W.css"])}));
//# sourceMappingURL=non_admin_invite_modal.min.js-vflteYuSr.map