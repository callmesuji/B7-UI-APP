define(["require","exports","tslib","lodash","rondo/index","rondo-saga/index","rondo-forms/field/field_behavior"],(function(e,t,n,r,i,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=(function(){function e(e,t,n){this.typeahead=e,this.id=n,this.query=t}return e.prototype.handleMembers=function(e){var t,i;return n.__generator(this,(function(n){switch(n.label){case 0:return t=this.typeahead.getState().fieldValue.map((function(e){return e.content})),(i=r.differenceWith(e,t,this.typeahead.comparator)).length>0?[4,a.put(this.typeahead.actionFieldReplace)({v:this.typeahead.parser(i[0]),id:this.id})]:[3,2];case 1:return n.sent(),[2,!1];case 2:return[2,!0]}}))},e.prototype.handleCancel=function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,a.put(this.typeahead.actionFieldReplace)({v:this.typeahead.tokenCreator(this.query,"error",this.id),id:this.id})];case 1:return e.sent(),[2]}}))},e})(),c=(function(){function e(e){this.typeahead=e}return e.prototype.handleMembers=function(e){return n.__generator(this,(function(t){switch(t.label){case 0:return[4,a.put(this.typeahead.actionMembersFetched)(e)];case 1:return t.sent(),[2,!0]}}))},e.prototype.handleCancel=function(){return n.__generator(this,(function(e){return[2,0]}))},e})(),u=(function(){function e(e){var t=this,u=e.dataSourceCreator,h=e.comparator,d=void 0===h?r.isEqual:h,l=e.tokenCreator,f=e.parser,p=e.fieldConfig,g=void 0===p?{initialValue:[]}:p;this.initialState=function(){return{suggestions:[]}},this.promiseState=function(e){return e.status="init",e.then((function(){return e.status="resolved"}),(function(){return e.status="rejected"})),e},this.actionInputChanged=i.createAction().takeLatest((function(e){return n.__generator(this,(function(t){switch(t.label){case 0:return[4,this.fetcher({query:e,tokenFetcher:new c(this)})];case 1:return t.sent(),[2]}}))})),this.actionEnter=i.createAction().takeLatest((function(e){var t;return n.__generator(this,(function(n){switch(n.label){case 0:return t=this.randomId(),[4,a.put(this.actionFieldAdd)([this.tokenCreator(e,"pending",t)])];case 1:return n.sent(),[4,this.fetcher({query:e,tokenFetcher:new o(this,e,t),timeoutPeriod:5e3})];case 2:return n.sent()?[3,4]:[4,a.put(this.actionFieldReplace)({v:this.tokenCreator(e,"error",t),id:t})];case 3:n.sent(),n.label=4;case 4:return[2]}}))})),this.actionFieldAdd=i.createAction().handle((function(){return{suggestions:[]}})),this.actionMembersFetched=i.createAction().handle((function(e,n){var i=e.fieldValue.map((function(e){return e.content})),a=r.differenceWith(n,e.suggestions.concat(i),t.comparator);return{suggestions:e.suggestions.concat(a)}})),this.actionReset=i.createAction().handle((function(){return{suggestions:[]}})),this.actionLocalReset=i.createAction().handle((function(){return{suggestions:[]}})),this.actionClear=i.createAction().handle((function(){return{suggestions:[]}})),i.extendBehavior(this,s.FieldArrayBehavior(n.__assign(n.__assign({},g),{clearActions:[this.actionClear],resetActions:[this.actionReset]}))),this._dataSourceObject=u,this.comparator=d,this.tokenCreator=l,this.parser=f}return e.prototype.randomId=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},e.prototype.fetcher=function(e){var t,r,i,s,o,c,u,h,d,l,f,p,g=e.query,y=e.tokenFetcher,_=e.timeoutPeriod;return n.__generator(this,(function(e){switch(e.label){case 0:return[4,a.put(this.actionLocalReset)()];case 1:e.sent(),t=this._dataSourceObject(g).map(this.promiseState),r=t.reduce((function(e,t,n){return e[n]=t,e}),{}),i=1,s=n.__assign({cancel:a.take([this.actionLocalReset])},r),_&&(s.timeout=a.delay(_),i++),e.label=2;case 2:if(!(Object.keys(s).length>i))return[3,11];e.label=3;case 3:return e.trys.push([3,9,,10]),[4,a.race(s)];case 4:return o=e.sent(),c=o.timeout,u=o.cancel,h=n.__rest(o,["timeout","cancel"]),u||c?[4,y.handleCancel()]:[3,6];case 5:return e.sent(),[2,!0];case 6:return d=Object.keys(h)[0],(l=h[d])&&l.query===g?(f=l.results,[4,y.handleMembers(f)]):[3,8];case 7:if(!e.sent())return[2,!0];e.label=8;case 8:return delete s[d],[3,10];case 9:for(p in e.sent(),r)"rejected"===r[p].status&&delete s[p];return[3,10];case 10:return[3,2];case 11:return[2,!1]}}))},e.displayName="Typeahead",e})();t.TypeaheadBehavior=u}));
//# sourceMappingURL=typeahead_picker_behavior.min.js-vflkmtbHN.map