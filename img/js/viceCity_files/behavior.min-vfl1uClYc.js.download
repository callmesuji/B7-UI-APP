define(["require","exports","tslib","redux-actions","lodash","redux-saga","rondo/behavior/types","rondo/behavior/internal_actions","rondo/action_listener_middleware/index","rondo/slice_selectors/index","rondo/behavior/compose/path","rondo/performance/mark","rondo/metadata/index","rondo/invariant/index","rondo/selectors/selector","rondo/behavior/compose/compose_behavior","rondo/actions/types","rondo/behavior/handle","rondo/behavior/initial_state","rondo/behavior/subscribers/index","rondo/behavior/utils","rondo/saga/saga_creator"],(function(t,e,i,r,o,s,n,a,c,h,p,d,l,u,f,_,v,g,y,E,m,b){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),o=i.__importStar(o),s=i.__importDefault(s);function S(t,r,o){var s,n=m.isBehaviorClass(t)?t:e.behavior(t),a=r||{slicePath:void 0,context:void 0},c=a.slicePath,h=a.context,p=i.__rest(a,["slicePath","context"]);return c||h?(u.invariant(0===Object.keys(p).length,"createBehavior options cannot include fields other than slicePath and context"),s=new n({slicePath:c,context:h})):s=Object.keys(p).length>0?new n(o,p):new n(void 0),s}e.behavior=function(t){return(function(e){function m(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var s=e.call(this,t.length>1?t[1]:void 0)||this;s.__type__=n.BEHAVIOR_FIELD_TYPE,s.sagas=[],s._path=[],s._registerCount=0,s.getState=function(){return u.invariant(!!s._getState,"Trying to access "+s.id+" state before store is set"),s.path.length>0?o.get(s._getState(),s.path):s._getState()},s.getFullState=function(){return u.invariant(!!s._getState,"Trying to access "+s.id+" state before store is set"),s._getState()},s.collectReducers=function(t){var e;if(t!==s){if(t.isRegistered)return;(e=s.actionHandlers).push.apply(e,i.__spread(t.actionHandlers||[]))}t.composedBehaviors&&t.composedBehaviors.forEach(s.collectReducers)},s.collectInitialStates=function(t){var e;if(t!==s){if(t.isRegistered)return;(e=s.initialStates).push.apply(e,i.__spread(t.initialStates||[]))}t.composedBehaviors&&t.composedBehaviors.forEach(s.collectInitialStates)},s.collectAction=function(t,e){return void 0===e&&(e={}),l.entriesOfTypeField(s,v.ACTION_FIELD_TYPE).forEach((function(t){var i=t.key,r=t.field;return o.set(e,s.path.concat(i),r)})),t.composedBehaviors&&t.composedBehaviors.forEach((function(t){return t.collectAction(t,e)})),e},s.collectActionWatcher=function(t){var e;if(t!==s){if(t.isRegistered)return;(e=s.actionWatchers).push.apply(e,i.__spread(t.actionWatchers||[]))}t.composedBehaviors&&t.composedBehaviors.forEach(s.collectActionWatcher)},s.collectSaga=function(t){var e,r;if(t!==s){if(t.isRegistered)return;(e=s.sagas).push.apply(e,i.__spread(t.sagas||[]))}(r=s.sagas).push.apply(r,i.__spread((t.sagaHandlers||[]).map((function(t){return t.create()})))),t.composedBehaviors&&t.composedBehaviors.forEach(s.collectSaga)};var a=t.length>=1&&n.isBehaviorOptions(t[0])?t[0]:void 0;return a&&(a.context&&(s.context=a.context),"string"==typeof a.slicePath&&(s.slice=a.slicePath)),s.bindMethodsToObject(),s.id=s._generateUniqueId(),s.sagaTasks=[],s.init(),a&&Array.isArray(a.slicePath)&&(s.path=a.slicePath),s}return i.__extends(m,e),m.prototype.ctrKeys=function(){return Object.keys(t.prototype).concat(Object.keys(this))},m.prototype.extendBehavior=function(t){var e=this;t.slice||(l.entriesOfTypeField(t,v.ACTION_FIELD_TYPE).forEach((function(i){var r=i.key;i.field;e.hasOwnProperty(r)||Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),l.entriesOfTypeField(t,f.SELECTOR_FIELD_TYPE).forEach((function(i){var r=i.key;i.field;e.hasOwnProperty(r)||Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),l.entriesOfTypeField(t,n.BEHAVIOR_FIELD_TYPE).forEach((function(i){var r=i.key;Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r)),e._ignoreCompose=(e._ignoreCompose||[]).concat(r)})))},m.prototype.init=function(){var t=this;l.entriesOfTypeField(this,n.BEHAVIOR_FIELD_TYPE,this.ctrKeys()).forEach((function(e){var i=e.key,r=e.field;(!t._ignoreCompose||t._ignoreCompose.indexOf(i)<0)&&_.composeBehavior(t,r,r.slice||i)})),this.actionWatchers=this.actionWatchers||[],this.actionHandlers=this.actionHandlers||[],this.initialStates=this.initialStates||[],this.initialState&&this.initialStates.push(new y.InitialState(this.initialState,this)),this.sagas=[],l.entriesOfTypeField(this,v.ACTION_FIELD_TYPE).forEach((function(e){var i=e.key;return e.field.init(t,l.camelCaseToUnderscorePattern(i))})),this.selectors=this.selectors||{},l.entriesOfTypeField(this,f.SELECTOR_FIELD_TYPE).forEach((function(e){var i=e.key,r=e.field;r.init(t),t.selectors[i]=r})),l.entriesOfTypeField(this,b.SAGA_FIELD_TYPE).forEach((function(e){var i=e.key,r=e.field.bind(t);t[i]=r,t.sagas.push(r)})),this.pendingComposedBehaviors&&this.pendingComposedBehaviors.length>0&&_.composeBehaviors(this.pendingComposedBehaviors.splice(0))(this),this._initBehaviorReducer()},m.prototype.bindMethodsToObject=function(){var e,r;try{for(var s=i.__values(Object.getOwnPropertyNames(t.prototype)),n=s.next();!n.done;n=s.next()){var a=n.value,c=this[a];o.isFunction(c)&&"constructor"!==a&&(this[a]=c.bind(this))}}catch(t){e={error:t}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(e)throw e.error}}},m.prototype.addBehavior=function(t){(this.pendingComposedBehaviors=this.pendingComposedBehaviors||[]).push(t),this.extendBehavior(t)},m.prototype.addUnsubscribers=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];(t=this.unsubscribers=this.unsubscribers||[]).push.apply(t,i.__spread(e))},Object.defineProperty(m.prototype,"_displayName",{get:function(){return this.constructor.displayName},enumerable:!0,configurable:!0}),m.prototype._generateUniqueId=function(){return"BEHAVIOR-"+(this._displayName?this._displayName+"-":"")+(this.slice?this.slice+"-":"")+Math.random().toString(36).substr(2,9)},m.prototype._initBehaviorReducer=function(){var t=this;this._attachReducer(a.actionInitBehavior(this.id),(function(e,i){var r=y.mergeInitialState(t.initialStates,t.path);return r?o.assignIn({},r,e):e}))},m.prototype._attachReducer=function(t,e){this.actionHandlers=this.actionHandlers||[],this.actionHandlers.push(new g.HandleAction(e,t,!1,!1,this,this))},Object.defineProperty(m.prototype,"path",{get:function(){return this._path?this._path.concat(this.slice||[]):[]},set:function(t){this._path=t,this.composedBehaviors&&p.setComposePath(this.composedBehaviors,this.path)},enumerable:!0,configurable:!0}),m.prototype.pathState=function(t){return this.path.length>0?o.get(t,this.path):t},Object.defineProperty(m.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.composedBehaviors&&this.composedBehaviors.forEach((function(e){return e.context=t}))},enumerable:!0,configurable:!0}),m.prototype.createWatchers=function(t){var e=t.get(n.ACTION_LISTENERS_MIDDLEWARE);e||(e=c.ActionListenerMiddleware(),t.register({name:n.ACTION_LISTENERS_MIDDLEWARE,middleware:e,order:0})),this.collectActionWatcher(this),this.addUnsubscribers.apply(this,i.__spread(this.actionWatchers.map((function(t){return t.create(e)}))))},m.prototype.middlewares=function(t){this.isRegistered||(this.createWatchers(t),this.createSagaMiddleware(t))},m.prototype.createSagaMiddleware=function(t){var e=t.get(n.SAGA_MIDDLEWARE);e||(e=s.default(),t.register({name:n.SAGA_MIDDLEWARE,middleware:e,order:0}))},m.prototype.postStoreCreation=function(e,i){var r=this;if(this.store=e,this.dispatch=e.dispatch,this._getState=e.getState,l.entriesOfTypeField(this,E.STATE_SUBSCRIBER_FIELD_TYPE).forEach((function(t){t.key;var i=t.field;i.behavior=r,i.store=e})),this.composedBehaviors&&this.composedBehaviors.forEach((function(t){t.postStoreCreation(e)})),i){var o=i.get(n.SAGA_MIDDLEWARE);o&&!this.isRegistered&&(this.collectSaga(this),this.sagas.forEach((function(t){return r.sagaTasks.push(o.run(t))})))}if(t.prototype.hasOwnProperty("ready")){var s=e.getState();this.ready(this.pathState(s),s)}},m.prototype.createReducer=function(){this.collectInitialStates(this),this.collectReducers(this);var t=y.mergeInitialState(this.initialStates,this.path);if(0===this.actionHandlers.length)return function(e){return void 0===e&&(e=t),e};var e=g.mergeHandles(this.actionHandlers);return r.handleActions(e,t)},m.prototype.createSelectors=function(){var t=this;return h.select(this.selectors,(function(e){return t.slice?e[t.slice]:e}))},Object.defineProperty(m.prototype,"isRegistered",{get:function(){return this._registerCount>0},enumerable:!0,configurable:!0}),m.prototype.register=function(){return this._registerCount++,(this.composedBehaviors||[]).forEach((function(t){return t.register()})),this._registerCount},m.prototype.unregister=function(t){return void 0===t&&(t=!1),this._registerCount--,(this.composedBehaviors||[]).forEach((function(t){return t.unregister(!0)})),this.isRegistered||(this.unsubscribers&&this.unsubscribers.length>0&&this.unsubscribers.splice(0).forEach((function(t){return t()})),t&&(this.actionWatchers=[],this.sagaHandlers=[],this.sagas=[]),this.sagaTasks.forEach((function(t){return t.cancel()})),this.sagaTasks=[],this.dispatch=void 0,this.store=void 0,this._getState=void 0),this._registerCount},m.__type__=n.BEHAVIOR_CLASS_FIELD_TYPE,m.displayName=(function(t){return t.hasOwnProperty("displayName")})(t)?t.displayName:(function(t){return t.hasOwnProperty("name")})(t)?t.name:"Behavior-"+Math.random().toString(36).substr(2,9),i.__decorate([d.markAroundDecorator("init")],m.prototype,"init",null),m})(t)},e.createBehavior=S,e.extendBehavior=function(t,e){m.isBehavior(e)||(e=S(e)),t.addBehavior(e)}}));
//# sourceMappingURL=behavior.min.js-vflBgFAQX.map