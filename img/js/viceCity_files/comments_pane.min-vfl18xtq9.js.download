define(["require","exports","tslib","react","react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/comments2/data/api","modules/clean/react/css","classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","lodash","comments2/components/comment/index","comments2/components/comment_editor/index","comments2/components/comment_stream/index","comments2/components/comment_stream/comment_stream_error","comments2/components/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/util","modules/clean/react/comments2/data/logger","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/redux/types","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions"],(function(e,t,n,o,r,a,s,i,m,c,l,d,p,u,g,h,f,_,C,y,v,E,w,T,b,S,P,M,I,A,k,D,R,O){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommentsPane=t.MobileCommentsTitle=t.CommentsPaneComponent=t.createDefaultNumberedAnnotation=void 0,o=n.__importDefault(o),r=n.__importStar(r),s=n.__importStar(s),c=n.__importDefault(c),p=n.__importStar(p),E=n.__importStar(E),P=n.__importStar(P),M=n.__importStar(M);var x=["how_to_at_mention_comments_pane_surface"];function V(e,t){return void 0===t&&(t=1),e===k.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[n.__assign({page:t},v.createFullRectangle())]}:{type:"image",region:v.createFullRectangle()}}function F(e){var t=e.currentPageIndex,r=void 0===t?0:t,a=e.disabledTimeCodeTooltipComponent,s=e.playerCurrentTime,i=void 0===s?0:s,m=e.playerCurrentTimeSec,c=void 0===m?0:m,l=e.pendingNumberedAnnotation,d=e.previewType;return d===k.PreviewType.Video?o.default.createElement(g.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:"video",time:i,timeSec:c},framePreciseCommentsEnabled:e.framePreciseCommentsEnabled,frameRate:e.frameRate,tooltipComponent:a})):d===k.PreviewType.Audio?o.default.createElement(g.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:"audio",time:i},tooltipComponent:a})):d===k.PreviewType.SsrDoc||d===k.PreviewType.Image?o.default.createElement(g.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:V(d,r+1),pendingAnnotation:l})):o.default.createElement(g.CommentEditor,n.__assign({},e))}t.createDefaultNumberedAnnotation=V;var N=(function(r){function i(t){var i=r.call(this,t)||this;return i.mentionsQueryId=0,i.onCommentStreamRef=function(e){return i.commentStream=e},i.updateMentionsMatches=function(e){i.setState({mentionsMatches:e})},i.logMentionsQueryCompletedPerf=function(e){var t=M.mentionsQueryCompleted();i.props.dispatch(b.Actions.logPerfEvent(t,e))},i.reloadComments=function(){i.props.dispatch(b.Actions.listComments(!0))},i.onMentionsQueryUpdated=function(e){if(e){var t=++i.mentionsQueryId;i.mentionsApi.query(e,i.updateMentionsMatches,M.withTiming(i.updateMentionsMatches,(function(e){i.mentionsQueryId===t&&i.logMentionsQueryCompletedPerf(e)})))}else""===e&&i.updateMentionsMatches(i.mentionsApi.getMatchesWithStarterSuggestions());i.props.dispatch(b.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},i.onPostSuccess=function(e,t){e.metadata&&e.metadata.some((function(e){return"mention"===e.type}))&&O.SharingActions.listMembers({user:t,contentId:i.props.stream.id,isFolder:!1,url:i.props.stream.linkUrl,includeSeenState:!1})},i.showEmailVerifyModal=function(e){if(!i.props.hasShownAnyModalVariant||e!==w.ShowModalReason.EditorFocus){i.props.dispatch(b.Actions.markModalVariantShown(w.ModalVariant.EmailVerifyModal)),E.logEvent("email_verify_modal_shown",{stream:i.props.stream});a.EmailVerification.get_for_user(i.props.viewer).show_verify_modal((function(){E.logEvent("email_verify_flow_completed",{stream:i.props.stream})}),s.ADD_COMMENT)}},i.showSignUpModal=function(t){if(!i.props.hasShownAnyModalVariant||t!==w.ShowModalReason.EditorFocus){i.props.dispatch(b.Actions.markModalVariantShown(w.ModalVariant.SignUpModal)),n.__awaiter(i,void 0,void 0,(function(){var t,r,a,s,i=this;return n.__generator(this,(function(m){switch(m.label){case 0:return[4,Promise.all([new Promise((function(t,n){e(["modules/clean/react/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/core/browser"],t,n)})).then(n.__importStar)])];case 1:return t=m.sent(),r=t[0].Modal,a=t[1].LoginOrRegisterModal,s=t[2],E.logEvent("sign_up_modal_shown",{stream:this.props.stream}),r.showInstance(o.default.createElement(a,{commentParams:{stream:this.props.stream,variant:d.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:d.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return s.reload()},onCancel:function(){return E.logEvent("sign_up_modal_dismissed",{stream:i.props.stream})},signup_tag:"comments_shmodel_modal_register",encryptionOptions:this.props.encryptionOptions})),[2]}}))}))}},i.createComment=function(e){switch(i.props.previewType){case k.PreviewType.Video:return o.default.createElement(u.TimeCodedComment,n.__assign({},e,{framePreciseCommentsEnabled:i.props.framePreciseCommentsEnabled,frameRate:i.props.frameRate,playerIntegrationEnabled:i.props.playerIntegrationEnabled}));case k.PreviewType.Audio:return o.default.createElement(u.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:i.props.playerIntegrationEnabled}));case k.PreviewType.Image:case k.PreviewType.SsrDoc:return o.default.createElement(u.NumberedComment,n.__assign({},e));default:return o.default.createElement(u.Comment,n.__assign({},e))}},i.createEditor=function(e){var t=i.props,r=t.currentPageIndex,a=t.framePreciseCommentsEnabled,s=t.frameRate,m=t.pendingNumberedAnnotation,c=t.playerCurrentTime,l=t.playerCurrentTimeSec,d=t.playerIntegrationEnabled,p=t.previewType,u=d?"target-annotation":"target-mention";return o.default.createElement(g.CoachMarkContainer,{className:u},o.default.createElement(F,n.__assign({},e,{disabledTimeCodeTooltipComponent:d?void 0:i.createDisabledTimeCodeTooltip,pendingNumberedAnnotation:m,currentPageIndex:r,framePreciseCommentsEnabled:a,frameRate:s,playerIntegrationEnabled:d,playerCurrentTime:c,playerCurrentTimeSec:l,previewType:p})))},i.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(R.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:i.onDisabledTooltipLearnMoreClick,onShow:i.onDisabledTooltipShow}))},i.onDisabledTooltipLearnMoreClick=function(){return E.logEvent("time_based_tooltip_learn_more_click",{stream:i.props.stream})},i.onDisabledTooltipShow=function(){return E.logEvent("time_based_tooltip_learn_more_view",{stream:i.props.stream})},i.mentionsApi=A.mentionsApi(t.viewer),i.state={mentionsMatches:i.mentionsApi.cache},i}return n.__extends(i,r),i.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,r=e.stream,a=+new Date;E.logEvent("show_comments",{stream:r}),t(b.Actions.logSimplePerfEvent("stream_displayed_ms",a-(o.listCompleteTime||0))),t(b.Actions.logSimplePerfEvent("comment_editor_tti_ms",a-(o.setContextTime||0))),n&&E.logEvent("sidebar_onboarding_shown",{stream:r})},i.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,r=o.showOnboarding,a=o.dispatch,s=o.requestEditorFocus,i=o.stream;!n&&r&&E.logEvent("sidebar_onboarding_shown",{stream:i}),!t&&s&&(this.commentStream.focusPrimaryEditor(),a(b.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(i.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,x)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return C.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!1,configurable:!0}),i.prototype.stickerSetsToStickerPacks=function(e){return e.map((function(e){return{url:e.url,stickers:e.stickers,description:e.description,name:e.name,id:e.set_id}}))},i.prototype.render=function(){var e,n=this.props,r=n.activeThreadId,a=n.collapsed,s=n.dispatch,i=n.editorIsEmpty,m=n.focusedThreadId,d=n.hoverThreadId,p=n.isMobile,u=n.showResolved,g=n.showCommentsError,C=n.showCommentsErrorIsPermissionsProblem,E=n.stream.id,w=n.thirdPartySource,b=n.threads,S=n.viewer,P=n.previewType,M=n.streamSettings,I=n.stickers,A=n.upsellTooltipVariant,R=b.filter((function(e){return u||!e.resolvedInfo}));e=S?T.dbxUserToIUser(S):_.getGuestIUser();var O=P===k.PreviewType.Image||P===k.PreviewType.SsrDoc,x=g&&(C?o.default.createElement(f.CommentStreamPermissionsError,{intl:l.intl}):o.default.createElement(f.CommentStreamError,{intl:l.intl,onClickRetry:this.reloadComments}));return o.default.createElement("div",{className:c.default("comments-pane-wrapper",{"no-comment":p&&0===R.length,"comments-pane-wrapper-show-resolved":u,"comments-pane-wrapper-hide-resolved":!u,"comments-pane-wrapper-all-changes-saved":!b.some((function(e){return!!e.pending})),"comments-upsell-eligible":!!A,"comments-upsell-ineligible":!A})},p&&o.default.createElement(t.MobileCommentsTitle,{commentCount:R.length}),x,o.default.createElement(h.CommentStream,{ref:this.onCommentStreamRef,id:E,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:p,mentionsMatches:this.state.mentionsMatches,settings:M,threads:R,user:e,activeThreadID:r,focusedThreadID:m,hoverThreadID:d,showUnreadPill:v.canShowUnreadPill(),localization:D.commentsMasterLocalization,collapsed:a,showRevisionInfo:O,stickerPacks:I&&this.stickerSetsToStickerPacks(I),thirdPartySource:w}),o.default.createElement(y.SidebarListener,{dispatch:s,editorIsEmpty:i,stream:this.props.stream}))},i})(o.default.Component);t.CommentsPaneComponent=N,t.MobileCommentsTitle=function(e){return o.default.createElement("div",{className:"comments-pane-wrapper__mobile-comments-title"},l.intl.formatMessage({id:"tcjpY3",defaultMessage:"Comments Â· {count}"},{count:e.commentCount}))};var U=r.connect((function(e){var t=P.getContext(e),n=t.stream,o=t.viewer,r=P.getData(e),a=r.perfEvents,s=r.upsellTooltipVariant,m=P.getListCommentsError(e),c=m instanceof i.Comments2Error&&m.code===i.ErrorCode.PERMISSION_DENIED;return{activeThreadId:P.getActivatedThreadId(e),editorIsEmpty:P.getEditorIsEmpty(e),focusedThreadId:P.getFocusedThreadId(e),hasShownAnyModalVariant:P.getHasShownAnyModalVariant(e),hoverThreadId:P.getHoverThreadId(e),playerCurrentTime:P.getPlayerCurrentTime(e),playerCurrentTimeSec:P.getPlayerCurrentTimeSec(e),framePreciseCommentsEnabled:P.getFramePreciseCommentsEnabled(e),frameRate:P.getFrameRate(e),playerIntegrationEnabled:P.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:P.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:P.getShowOnboardingOnCommentsPane(e),showResolved:P.getShowResolved(e),pendingNumberedAnnotation:P.getPendingNumberedAnnotation(e),previewType:P.getPreviewTypeForCurrentFile(e),currentPageIndex:S.getCurrentPageIndex(e),showCommentsError:P.getStatuses(e)[b.ActionTypes.ListComments.name]===I.ApiClientStatus.Error,showCommentsErrorIsPermissionsProblem:c,stream:n,thirdPartySource:P.getThirdPartySource(e),threads:P.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:a,requestEditorFocus:P.getIsEditorFocusRequested(e),streamSettings:P.getStreamSettings(e),stickers:P.getStickers(e)}}))(N);t.CommentsPane=m.requireCssWithComponent(U,["/static/js/comments2/index.web-vflLSTC4h.css","/static/css/comments2-vflV_pg-R.css","/static/css/snackbar-vflrE3onl.css"])}));
//# sourceMappingURL=comments_pane.min.js-vfl3C5QUE.map